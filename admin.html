<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVMinigames | Inspiration</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"/>
    <meta name="twitter:card" content="A community led effort for the metaverse."/>
    <meta name="twitter:site" content="@CVMiniGames"/>
    <meta name="twitter:creator" content="@CVMiniGames"/>
    <meta property="og:url" content="http://www.cvminigames.com"/>
    <meta property="og:title" content="CVMiniGames Homepage"/>
    <!-- <meta name="theme-color" media="(prefers-color-scheme: light)" content="#3880ff" /> -->
    <!-- Tabulator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.1.7/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.1.7/css/tabulator.min.css" />
    <!-- Additional Meta's -->
    <meta property="og:description" content="Join the community and get the $1 token that unlocks access to a meta-world of fun!"/>
    <meta property="og:image" content="http://graphics8.nytimes.com/images/2011/12/08/technology/bits-newtwitter/bits-newtwitter-tmagArticle.jpg"/>
  </head>
  <body>
    <button id='npcBtn'>NPC Panel </button> | <button id='ruleBtn'>Rules Panel</button>
    <style> #myNPCs, #myRules, #myThens, #myIfs { width: 600px; } </style>
    <style>
      table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
      }
      
      td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
      }
      
      tr:nth-child(even) {
        background-color: #dddddd;
      }
    </style>
    <div id='npcDiv' style='display: flex;flex-direction: column;align-items: center;'>
      
      <h2>NPC </h2>
      <div>
        <p>Allow people to talk with your Vox models as though they were NPCs</p>
        <p> 1. Write up a dialog tree using <a href='https://www.inklewriter.com/'>www.inklewriter.com</a> </p> 
        <details style='display:inline'><summary>About InkleWriter</summary> 
          <div style='background:lightgray'>
            <p>Accounts are free to create requiring only an email.</p>
            <p>This lets you store and share your dialogs in json notation.</p> 
            <p>Use this <a href='https://www.inklewriter.com/'> Tutorial </a> to get started.</p>
          </div>
        </details>
        <p> 2. Connect the dialog to an npc here</p>
        <p> 3. <b>Advanced</b>: Add interaction rules based on the npc dialog progression. </p>
      </div>
      <br>
      <button id='createNpcBtn'>Create New NPC</button> 
      <br>

      <!-- { feature: 'yadayada', dialog: 'inklewriter.com?id=2342452.json'} -->
      <div id='npcEditorDiv' style='display:none'>
        
        <label for="npcFeatureIdInput">For NPC:</label>
        <select id='npcFeatureIdInput'></select>
        <br>

        <label for="npcInklewriterIdInput">Inklewriter ID:</label>
        <input type="text" id="npcInklewriterIdInput" name="npcInklewriterIdInput" value='inklewriter.com?id=2342452.json'>
        <dialog style='position:relative; display:inline-block'>
          <summary><a>?</a></summary>
        </dialog>
        <br>
        
        <button id='uploadNewNpc'>Submit</button>
        <button id='updateOldNpc' style='display:none'>Update</button>
      </div>
      <br>
      
      <h3>My NPCs </h3>
      <table>
        <thead>
          <tr>
            <th>NPC's FeatureId</th>
            <th>Inklewriter ID</th>
            <th>Edit</th>
          </tr>
         </thead>
         <tbody id='myNPCs'>
         </tbody>
      </table>
      
    </div>
    
    <div id='ruleDiv' style='display: flex;flex-direction: column;align-items: center;'>
      <h2>Rules </h2>
      
      <h3>My Rules </h3>
      <button id='createIfThen'>Create New 'If-Then' Rule</button>
      <div id='createIfThenDiv' style='display:none; '>
        ||| RULES CREATION TOOL ||| 

        <button id='uploadNewRule'>Submit</button>
        <button id='updateOldRule' style='display:none'>Update</button>
        
      </div>
      <table>
        <thead>
          <tr>
            <th>If</th>
            <th>Conditions</th>
            <th>Then</th>
            <th>Actions</th>
            <th>Edit</th>
          </tr>
         </thead>
         <tbody id='myRules'> </tbody>
      </table>
      
      <h3>My 'If's Conditions </h3>
      <button id='createIf'>Create New 'If' Condition</button>
      <div id='createIfDiv' style='display:none'> 
        <label for="rules">IF:</label>
        <select name="rules">
            <option value="onclick">onclick</option>
            <option value="onstart">onstart</option>
            <option value="hastoken">hastoken</option>
            <option value="atstage">atstage</option>
            <option value="atlinkid">atlinkid</option>
            <option value="ingate">ingate</option>
            <option value="gateexists">gateexists</option>
        </select>

        <button id='uploadNewIf'>Submit</button>
        <button id='updateOldIf' style='display:none'>Update</button>
        
      </div>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>If</th>
            <th>Condition</th>
            <th>Edit</th>
          </tr>
         </thead>
         <tbody id='myIfs'> </tbody>
      </table>
      
      <h3>My 'Then' Actions </h3>
      <button id='createThen'>Create New 'Then' Commands</button>
      <div id='createThenDiv' style='display:none'> 
        <label for="component">For:</label>
        <select name="component">
            <option value="feature">feature</option>
            <option value="bounds">bounds</option>
            <option value="globalVars">globalVars</option>
        </select>
        <label for="properties">SET:</label>
        <select name="properties">
            <option value="props">props</option>
            <option value="svg">svg</option>
            <option value="animation">animation</option>
            <option value="locked">locked</option>
            <option value="unlocked">unlocked</option>
        </select>

        <button id='uploadNewThens'>Submit</button>
        <button id='updateOldThens' style='display:none'>Update</button>
        
      </div>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Then</th>
            <th>Action</th>
            <th>Edit</th>
          </tr>
         </thead>
         <tbody id='myThens'> </tbody>
      </table>
    </div>
  </body>
</html>



<script>  
(async () => {  
  async function getCVParcelData(parcel){ return (await ( await fetch( "https://cc6jt4sss6.execute-api.us-east-1.amazonaws.com/default/bypassCors?parcel="+parcel )  ).json() ).parcel }
  async function getNPCDialogData(){ return (await ( await fetch( "https://www.charleskarpati.com/api/?fn=dialog&parcel="+parcel.id )  ).json() ) }
  let parcel = await getCVParcelData('6463')
  let dialogs = await getNPCDialogData(parcel)
  console.log({parcel,dialogs})  

  
  //
  // Get list of features
  //
  document.getElementById("npcFeatureIdInput").innerHTML = ''
  let features = parcel.content.features.map(ft => { 
    let keep = ['collectible-model', 'megavox', 'vox-model']
    let skip = ( !keep.includes(ft.type) || typeof ft.id == 'undefined' ||  ft.id == '' )
    if( skip ){ return false }
    document.getElementById("npcFeatureIdInput").innerHTML += `<option value="${ft.id}">${ft.id}</option>`
    return !skip && ft
  });

  //
  // Toggle View
  let npcDiv = document.getElementById("npcDiv") 
  let ruleDiv = document.getElementById("ruleDiv") 
  
  let ruleBtn = document.getElementById("ruleBtn")
  ruleBtn.addEventListener("click", function() {
    npcDiv.style.display='none'
    ruleDiv.style.display='flex'
  });
  
  let npcBtn = document.getElementById("npcBtn") 
  npcBtn.addEventListener("click", function() {
    ruleDiv.style.display='none'
    npcDiv.style.display='flex'
  })

  /* //
  //
  // Connect NPC Dialogs
  //
  // */
  
  //
  // Show NPC Panel, load npc table
  npcBtn.addEventListener("click", function() {
    ruleDiv.style.display='none'
    npcDiv.style.display='flex'
    var myNPCs = document.getElementById("myNPCs")
    myNPCs.innerHTML = ''
    dialogs.map((dialog, index) => {
      myNPCs.innerHTML += ` 
        <tr value=${index}>
          <td>${dialog.featureId}</td>
          <td>${dialog.inklewriterId}</td>
          <td><button onclick="updateNpc(this)">Edit</button></td>
        </tr>
      `
    })
  });

  let npcEditorDiv = document.getElementById("npcEditorDiv")

  //
  // Open 'Create NPC' interface
  document.getElementById("createNpcBtn").addEventListener("click", async function() {
    npcEditorDiv.style.display='block'
    updateOldNpc.style.display='none'
    uploadNewNpc.style.display='block'
  })
  
  //
  // Open'Edit NPC' interface 
  window.npcUpdated = ''
  window.updateNpc = async (e) => {
    let tr = e.parentNode.parentNode 
    npcUpdated = dialogs[parseInt(tr.getAttribute('value') )]
    tr = tr.childNodes
    document.getElementById("npcFeatureIdInput").value =  tr[1].innerHTML
    document.getElementById("npcInklewriterIdInput").value = tr[3].innerHTML
    updateOldNpc.style.display='block'
    uploadNewNpc.style.display='none'
    npcEditorDiv.style.display='block'
  }

  //
  // On Submit from New/OLD BTN NPC 
  const uploadNpcFn = async (state) => {
    console.log('uploadNewNpc Called', state)
    // Closure to capture the file information.
    let iw = document.getElementById('npcInklewriterIdInput').value
    let nf = document.getElementById('npcFeatureIdInput').value
    let body = { "parcel": parcel.id, "inklewriterId": iw, "featureId": nf }
    if(state=='old'){
      console.log({body, npcUpdated})
      body.id= npcUpdated.id
      body.timestamp = npcUpdated.timestamp
    }
    console.log('submit: ', {body})
    let url = "https://charleskarpati.com/api/?fn=dialog"	
    let postOptions = { method: 'POST', body: JSON.stringify(body) }; 
    let resp = ( await ( await fetch( url, postOptions ) ).text() )
    console.log({resp})
    npcEditorDiv.style.display='none'
  }
  
  let uploadNewNpc = document.getElementById("uploadNewNpc")
  uploadNewNpc.addEventListener('click', function () {uploadNpcFn('new');});

  let updateOldNpc = document.getElementById("updateOldNpc")
  updateOldNpc.addEventListener('click', function () {uploadNpcFn('old');});


  /* //
  //
  // Rules
  //
  // */

  //
  // Create If Rules
  // 

  ruleBtn.addEventListener("click", function() {
    ruleDiv.style.display='flex'
    npcDiv.style.display='none'
    let myIfs = document.getElementById("myIfs")
    let myThens = document.getElementById("myThens") 
    
    let myRules = document.getElementById("myRules")
    myIfs.innerHTML = '';
    myThens.innerHTML = '';
    myRules.innerHTML = ''
    dialogs.map((dialog, index) => {
      myIfs.innerHTML += ` 
        <tr value=${index}>
          <td>${dialog.featureId}</td>
          <td>${dialog.inklewriterId}</td>
          <td>${dialog.inklewriterId}</td>
          <td><button onclick="updateIfs(this)">Edit</button></td>
        </tr>`;
      myThens.innerHTML += `
        <tr value=${index}>
          <td>${dialog.featureId}</td>
          <td>${dialog.inklewriterId}</td>
          <td>${dialog.inklewriterId}</td>
          <td><button onclick="updateThens(this)">Edit</button></td>
        </tr>`;
      
      myRules.innerHTML += ` 
        <tr value=${index}>
          <td>${dialog.featureId}</td>
          <td>${dialog.featureId}</td>
          <td>${dialog.inklewriterId}</td>
          <td>${dialog.inklewriterId}</td>
          <td><button onclick="updateRules(this)">Edit</button></td>
        </tr>`;
    })
  });
  
  //
  // Create Then Rules
  // 
  
  //
  // Create If-Then Rules
  //    
  let createIfDiv = document.getElementById("createIfDiv")
  document.getElementById("createIf").addEventListener("click", function() {
    document.getElementById("createIfDiv").style.display='block'
    createIfDiv
  }); 

  //
  // CREATE IF-THEN
  // 
  let createIfThenDiv = document.getElementById("createIfThenDiv") 
  
  let createIfThen = document.getElementById("createIfThen")
  createIfThen.addEventListener("click", function() {
    createIfThenDiv.style.display='block'
  });

  //
  // Then
  //

  let createThenDiv = document.getElementById("createThenDiv")
  let createThen = document.getElementById("createThen")
  createThen.addEventListener("click", function() {
    createThenDiv.style.display='block'
  });
  
  ruleBtn.click()
  // createNpcBtn.click()
})();
</script>